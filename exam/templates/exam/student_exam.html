{% extends 'base.html' %}
{% load static %}

{% block title %}{{ exam.title }} - Take Exam{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Exam Information Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        {{ exam.title }}
                    </h4>
                </div>
                <div class="card-body">
                    {% if exam.description %}
                        <p class="text-muted">{{ exam.description }}</p>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-clock me-1"></i> Duration:</h6>
                            <p class="mb-2">{{ exam.duration_minutes }} minutes</p>
                            
                            <h6><i class="fas fa-calendar me-1"></i> Available:</h6>
                            <p class="mb-2">{{ exam.start_date_time|date:"M d, Y H:i" }} - {{ exam.end_date_time|date:"M d, Y H:i" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-user-graduate me-1"></i> Teacher:</h6>
                            <p class="mb-2">{{ exam.teacher.get_full_name }}</p>
                            
                            <h6><i class="fas fa-redo me-1"></i> Attempts:</h6>
                            <p class="mb-2">{{ attempts_made }} / {{ max_attempts }} used</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status and Action Card -->
            <div class="card shadow">
                <div class="card-body">
                    {% if exam_status == 'upcoming' %}
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-clock me-2"></i>
                            <strong>Coming Soon</strong> - This exam is not yet available. Please wait until {{ exam.start_date_time|date:"M d, Y H:i" }}.
                        </div>
                    
                    {% elif exam_status == 'expired' %}
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>Expired</strong> - This exam is no longer available. The deadline was {{ exam.end_date_time|date:"M d, Y H:i" }}.
                        </div>
                    
                    {% elif exam_status == 'inactive' %}
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-pause-circle me-2"></i>
                            <strong>Exam Disabled</strong> - This exam has been temporarily disabled by the instructor.
                        </div>

                    {% elif exam_status == 'no_access' %}
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-lock me-2"></i>
                            <strong>No Access</strong> - You do not have permission to take this exam.
                        </div>
                    
                    {% elif exam_status == 'no_attempts' %}
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-ban me-2"></i>
                            <strong>No More Attempts</strong> - You have used all {{ max_attempts }} attempts for this exam.
                        </div>
                    
                    {% elif exam_status == 'in_progress' %}
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-play-circle me-2"></i>
                            <strong>Exam in Progress</strong> - You have an ongoing exam session that you started earlier.
                            {% if time_remaining %}
                                <br><small><i class="fas fa-clock me-1"></i>Time remaining: <span id="time-display">{{ time_remaining }}</span> seconds</small>
                            {% endif %}
                            <br><small><i class="fas fa-info-circle me-1"></i>You can continue where you left off. Your answers are automatically saved as you progress.</small>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'exam:dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>
                                Back to Dashboard
                            </a>
                            <a href="{% url 'exam:take_exam' submission_id=ongoing_submission.id %}" class="btn btn-success btn-lg">
                                <i class="fas fa-play me-1"></i>
                                Continue Exam
                            </a>
                        </div>
                    
                    {% elif exam_status == 'available' %}
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Ready to Start</strong> - You can start this exam now.
                            <br><small>Remaining attempts: {{ remaining_attempts }}</small>
                        </div>
                        
                        <!-- Important Warning -->
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> Once you click "Start Exam", your attempt will be counted immediately and the timer will begin. 
                            If you close the browser or navigate away, you can return to continue the exam, but the attempt will still be used. 
                            Make sure you're ready before starting!
                        </div>
                        
                        <!-- Start Exam Form -->
                        <form method="post" action="{% url 'exam:start_exam' pk=exam.pk %}" onsubmit="return confirmStart();">
                            {% csrf_token %}
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'exam:dashboard' %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>
                                    Back to Dashboard
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-play me-1"></i>
                                    Start Exam
                                </button>
                            </div>
                        </form>
                    
                    {% else %}
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Unavailable</strong> - This exam is currently not available.
                        </div>
                        
                        <a href="{% url 'exam:dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Back to Dashboard
                        </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Previous Attempts -->
            {% if completed_submissions %}
                <div class="card shadow mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            Previous Attempts
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Attempt #</th>
                                        <th>Date Taken</th>
                                        <th>Score</th>
                                        <th>Percentage</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for submission in completed_submissions %}
                                        <tr>
                                            <td>{{ submission.attempt_number }}</td>
                                            <td>{{ submission.submitted_at|date:"M d, Y H:i" }}</td>
                                            <td>{{ submission.score }} / {{ submission.total_marks }}</td>
                                            <td>{{ submission.percentage|floatformat:1 }}%</td>
                                            <td>
                                                {% if submission.auto_submitted %}
                                                    <span class="badge bg-warning">Auto-submitted</span>
                                                {% else %}
                                                    <span class="badge bg-success">Completed</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'exam:exam_result' submission_id=submission.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>
                                                    View Results
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function confirmStart() {
    return confirm('⚠️ IMPORTANT: Starting this exam will immediately consume one of your attempts, even if you don\'t complete it.\n\nThe timer will start now and cannot be paused. If you close your browser or navigate away, you can return to continue, but the attempt will still be used.\n\nAre you sure you want to start this exam?');
}

// Update time display if exam is in progress
{% if exam_status == 'in_progress' and time_remaining %}
let timeRemaining = {{ time_remaining }};
const timeDisplay = document.getElementById('time-display');

function updateTimer() {
    if (timeRemaining <= 0) {
        location.reload(); // Refresh to show time up status
        return;
    }
    
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    timeRemaining--;
}

setInterval(updateTimer, 1000);
updateTimer(); // Initial call
{% endif %}
</script>
{% endblock %}